<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modificar Equipo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    {% include 'navbar.html' %}

    <div class="container mt-5">
        <h1>Modificar Equipo</h1>
        <h3>Jugadores de tu Equipo</h3>
        
        <!-- Lista de jugadores actuales en el equipo -->
        <h4>Jugadores Actuales</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Posición</th>
                    <th>Rol</th>
                    <th>Precio</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="jugadores-equipo">
                <!-- Aquí se mostrarán los jugadores actuales -->
            </tbody>
        </table>

        <h3>Jugadores Disponibles para Transferencia</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Posición</th>
                    <th>Precio</th>
                    <th>Estado</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody id="jugadores-transferencia">
                <!-- Aquí se mostrarán los jugadores disponibles filtrados por posición -->
            </tbody>
        </table>

        <!-- Botón para confirmar cambios -->
        <div class="mt-4">
            <button class="btn btn-success" id="confirmar-cambios">Confirmar Cambios</button>
        </div>
    </div>

    <script>
        let jugadores = []; // Estado para los jugadores actuales
        let jugadoresDisponibles = []; // Estado para los jugadores disponibles

        document.addEventListener('DOMContentLoaded', async () => {
            const equipoId = window.location.pathname.split('/')[2]; // Obtiene el ID del equipo desde la URL
            const token = localStorage.getItem('access_token');
            console.log('Equipo ID:', equipoId);
            console.log('Token:', token);

            const response = await fetch(`/equipojugador`, { 
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                console.log('Respuesta del servidor:', data); // Verifica qué datos recibes del backend
                console.log('formacion:', data.formacion);
                
                if (data && Array.isArray(data.jugadores)) {
                    // Guardar jugadores actuales en el estado
                    jugadores = data.jugadores;
                    renderJugadoresEquipo(jugadores);
                } else {
                    console.log('No se encontraron jugadores en la respuesta.');
                    renderJugadoresEquipo([]);  // En caso de que no haya jugadores
                }
            } else {
                const errorData = await response.json();
                console.log('Error:', errorData);
                document.getElementById('equipo-info').innerHTML = `
                    <p class="text-danger">Error: ${errorData.message}</p>
                `;
            }
        });

        // Renderizar jugadores actuales en el equipo
        function renderJugadoresEquipo(jugadores) {
            const jugadoresTable = document.getElementById('jugadores-equipo');
            jugadoresTable.innerHTML = ''; // Limpiar la tabla antes de agregar

            // Verifica si la lista de jugadores está definida y no es vacía
            if (Array.isArray(jugadores) && jugadores.length > 0) {
                jugadores.forEach(jugador => {
                    const rolMap = {1: 'Titular', 2: 'Suplente', 3: 'Capitán'};
                    jugadoresTable.innerHTML += `
                        <tr>
                            <td>${jugador.nombre}</td>
                            <td>${jugador.posicion}</td>
                            <td>${rolMap[jugador.rol]}</td>
                            <td>${jugador.precio}</td>
                            <td>${jugador.estado}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="seleccionarJugadorParaTransferencia(${jugador.id}, '${jugador.posicion}')">Transferir</button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                jugadoresTable.innerHTML = `
                    <tr>
                        <td colspan="6">No hay jugadores en tu equipo.</td>
                    </tr>
                `;
            }
        }

        // Función para seleccionar un jugador y cargar jugadores disponibles por su posición
        async function seleccionarJugadorParaTransferencia(jugadorId, posicion) {
            console.log('Jugador seleccionado:', jugadorId, 'Posición:', posicion);

            const jugadoresDisponiblesResponse = await fetch(`/jugadores?posicion=${posicion}`, { 
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });

            if (jugadoresDisponiblesResponse.ok) {
                const jugadoresDisponiblesResponseData = await jugadoresDisponiblesResponse.json();
                console.log('Jugadores disponibles:', jugadoresDisponiblesResponseData);
                jugadoresDisponibles = jugadoresDisponiblesResponseData;
                renderJugadoresTransferencia(jugadoresDisponibles);
            } else {
                console.log('Error al obtener jugadores disponibles.');
                renderJugadoresTransferencia([]);
            }
        }

        // Renderizar jugadores disponibles para transferencia filtrados por posición
        function renderJugadoresTransferencia(jugadoresDisponibles) {
            const jugadoresTable = document.getElementById('jugadores-transferencia');
            jugadoresTable.innerHTML = ''; // Limpiar la tabla antes de agregar

            if (Array.isArray(jugadoresDisponibles) && jugadoresDisponibles.length > 0) {
                jugadoresDisponibles.forEach(jugador => {
                    jugadoresTable.innerHTML += `
                        <tr>
                            <td>${jugador.nombre}</td>
                            <td>${jugador.posicion}</td>
                            <td>${jugador.precio}</td>
                            <td>${jugador.estado}</td>
                            <td>
                                <button class="btn btn-info btn-sm" onclick="transferirJugador(${jugador.id})">Transferir</button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                jugadoresTable.innerHTML = `
                    <tr>
                        <td colspan="5">No hay jugadores disponibles para esta posición.</td>
                    </tr>
                `;
            }
        }

        // Función para transferir jugador (mover entre equipos)
        function transferirJugador(jugadorId) {
            // Aquí es donde podrías cambiar el jugador entre las listas de jugadores
            console.log('Jugador transferido:', jugadorId);
            // Esto solo debe actualizar el estado local y luego proceder a actualizar el backend
            const jugador = jugadoresDisponibles.find(j => j.id === jugadorId);
            jugadores.push(jugador); // Agregar jugador al equipo
            renderJugadoresEquipo(jugadores);
        }

        // Confirmar cambios
        document.getElementById('confirmar-cambios').addEventListener('click', async () => {
            const equipoId = window.location.pathname.split('/')[2];  // Obtén el ID del equipo desde la URL
            let accion = ''; // Esta variable se definirá según la acción seleccionada
            let jugadorEntranteId = null;
            let jugadorSalienteId = null;
            let nuevoCapitanId = null;

            // Aquí determinarás qué acción se tomará según la lógica de tu aplicación
            // Este ejemplo solo cubre una acción de 'transferencia' como ilustración:

            // Suponiendo que has seleccionado un jugador para transferencia o cambio de capitán
            if (accionSeleccionada === 'transferencia') {
                // Supón que tienes los IDs de los jugadores entrante y saliente
                jugadorEntranteId = seleccionadoParaTransferencia.id;
                jugadorSalienteId = jugadorSeleccionado.id;  // El jugador que está saliendo del equipo
                accion = 'transferencia';
            } else if (accionSeleccionada === 'cambio') {
                // Lógica para cambio de jugadores dentro del equipo
                jugadorEntranteId = jugadorNuevo.id;
                jugadorSalienteId = jugadorActual.id;
                accion = 'cambio';
            } else if (accionSeleccionada === 'cambio capitan') {
                // Lógica para cambio de capitán
                nuevoCapitanId = nuevoCapitan.id;
                accion = 'cambio capitan';
            }

            // Crear el cuerpo de la petición según la acción
            const body = {
                accion: accion,
            };

            if (accion === 'transferencia' || accion === 'cambio') {
                body.jugador_entrante_id = jugadorEntranteId;
                body.jugador_saliente_id = jugadorSalienteId;
            }

            if (accion === 'cambio capitan') {
                body.jugador_capitan_id = nuevoCapitanId;
            }

            // Realiza la petición PATCH al backend
            const response = await fetch(`/equipo/${equipoId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                },
                body: JSON.stringify(body),  // El cuerpo de la petición
            });

            if (response.ok) {
                alert('Equipo actualizado exitosamente');
            } else {
                const errorData = await response.json();
                alert(`Error al actualizar el equipo: ${errorData.message}`);
            }
        });

    </script>
</body>
</html>
